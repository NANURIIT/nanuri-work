<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nanuri.work.business.duty.mapper.DutyMapper">

	<!-- 근태등록 -->
	<insert id="insertOnDuty" parameterType="com.nanuri.work.business.duty.dto.DutyHistoryDTO">
		INSERT INTO dut_hst (
			user_id, 
			bas_dt, 
			svce_form_cd, 
			st_dt, 
			st_tm, 
			aaw_btn_clk_dtm, 
			ed_dt, 
			ed_tm, 
			sbt_num, 
			svce_prjt_txt
		) VALUES (
			#{userId}, 
			#{basDt}, 
			#{svceFormCd}, 
			#{stDt}, 
			#{stTm}, 
			#{aawBtnClkDtm}, 
			#{edDt}, 
			#{edTm}, 
			#{sbtNum}, 
			#{svcePrjtTxt}
		)
	</insert>
	
	<insert id="insertOffDuty" parameterType="com.nanuri.work.business.duty.dto.DutyHistoryDTO">
		INSERT INTO dut_hst (
			user_id, 
			bas_dt, 
			svce_form_cd, 
			st_dt, 
			st_tm, 
			ed_dt, 
			ed_tm, 
			sbt_num, 
			svce_prjt_txt, 
			rsn_txt
		) VALUES 
		<foreach collection="list" item="item" separator=",">
		(
			#{item.userId}, 
			#{item.basDt}, 
			#{item.svceFormCd}, 
			#{item.stDt}, 
			#{item.stTm}, 
			#{item.edDt}, 
			#{item.edTm}, 
			#{item.sbtNum}, 
			#{item.svcePrjtTxt}, 
			#{item.rsnTxt}
		)	
		</foreach>
	</insert>
	
	<!-- 휴가 계산 -->
	<select id="calVacation" parameterType="java.util.HashMap" resultType="string">
		SELECT bas_dt
		  FROM hldy_info
		 WHERE bas_dt BETWEEN #{stDt} AND #{edDt}
		   AND hldy_yn = 'N'
	</select>
	
	<!-- 근태 조회 -->
	<select id="selectDutyHistoryList" parameterType="string" resultType="com.nanuri.work.business.duty.vo.DutyHistoryVO">
		SELECT T01.seq_no, 
			   T02.user_nm,
			   T02.tel_no,  
			   T02.dty_nm, 
			   T02.blg_nm, 
			   T01.bas_dt, 
			   T01.svce_form_cd, 
			   T03.dtl_cnm AS svce_form_cd_nm, 
			   T01.st_dt, 
			   T01.st_tm, 
			   T01.ed_dt, 
			   T01.ed_tm, 
			   (
			   		SELECT COUNT(*)
			   			   FROM hldy_info
			   		 WHERE (bas_dt BETWEEN T01.st_dt AND T01.ed_dt)
			   		   AND hldy_yn = 'N'
			   ) AS prd, 						/* 전체 기간 일수 */ 
			   T01.rg_dtm,
			   T01.dcz_sts_cd,  
			   T04.dtl_cnm AS dcz_sts_cd_nm,
			   (
			   		SELECT (
			   			(SELECT asg_dys + ans_dys
			   			   FROM vctn_asg
			   			  WHERE bas_yy = DATE_FORMAT(NOW(), '%Y')
			   			    AND user_id = T01.user_id) - 
			   			 (SELECT SUM(sbt_num)
			   			    FROM dut_hst
			   			   WHERE sbt_num != 0
			   			     AND user_id = T01.user_id
			   			     AND dcz_sts_cd = 'CONFIRM')
			   		)
			   		  FROM DUAL
			   ) AS sbt_aft_vctn_dys, 
			   T01.dcz_dtm, 
			   T01.dczmn_id
		  FROM dut_hst T01
	 LEFT JOIN mem_bsc_info T02
	 		ON T01.user_id = T02.user_id
	 LEFT JOIN (
	 		SELECT ds_cd, 
	 			   dtl_ds_cd, 
	 			   dtl_cd, 
	 			   dtl_ds_cd_nm, 
	 			   dtl_cnm
	 		  FROM comn_cd
	 		 WHERE ds_cd = 'DUTY'
	 		) T03
	 		ON T01.svce_form_cd = T03.dtl_cd
	 LEFT JOIN (
	 		SELECT ds_cd, 
	 			   dtl_cd, 
	 			   dtl_cnm
	 		  FROM comn_cd
	 		 WHERE ds_cd = 'CONFIRM'
	 		) T04
	 		ON T01.dcz_sts_cd = T04.dtl_cd
	 		WHERE 1=1
	 		<if test="userId != null and userId != ''">
	 			AND T01.user_id = #{userId}
	 		</if> 
	 		<!-- 근무 형태 검색 -->
	 		<if test="searchType != null and searchType != ''">
	 			AND T01.svce_form_cd = #{searchType}
	 		</if>
	 		<!-- 직원명 검색 -->
	 		<if test="searchKeyword != null and searchKeyword != ''">
	 			AND T02.user_nm = #{searchKeyword}
	 		</if>
	 		<!-- 기준 년도 검색 -->
	 		<if test="searchDate != null and searchDate != ''">
	 			AND DATE_FORMAT(T01.bas_dt, '%Y') = #{searchDate}
	 		</if>
	 		<!-- 기준 년도 올해 default -->
	 		<if test="searchDate == null or searchDate == ''">
	 			AND DATE_FORMAT(T01.bas_dt, '%Y') = DATE_FORMAT(NOW(), '%Y')
	 		</if>
	  ORDER BY T01.seq_no DESC
	  <include refid="CommonMapper.paging" />
	</select>

	<!-- 마지막 근태기록 조회 -->
	<select id="selectLastDutyHistoryDetail" parameterType="string" resultType="com.nanuri.work.business.duty.dto.DutyHistoryDTO">
		SELECT seq_no,
			   bas_dt, 
			   svce_form_cd, 
			   st_dt, 
			   st_tm, 
			   ed_dt, 
			   ed_tm, 
			   svce_prjt_txt
		  FROM dut_hst T01
	 LEFT JOIN comn_cd T02
	 		ON T01.svce_form_cd = T02.dtl_cd
		 WHERE user_id = #{userId}
		   AND T02.dtl_ds_cd = 'ON_DUTY'
	  ORDER BY T01.rg_dtm DESC
	     LIMIT 1
	</select>
	
	<!-- 퇴근등록 -->
	<update id="updateDuty" parameterType="com.nanuri.work.business.duty.dto.DutyHistoryDTO">
		UPDATE dut_hst
		   SET svce_form_cd = #{svceFormCd},
		   	   ed_dt = #{edDt}, 
		   	   ed_tm = #{edTm}, 
		   	   ckof_btn_clk_dtm = #{ckofBtnClkDtm}, 
		   	   sbt_num = #{sbtNum}
		 WHERE user_id = #{userId}
		   AND seq_no = #{seqNo}
	</update>
	
	<!-- 근태 정보 갯수 출력 -->
	<select id="selectTotalCountDutyHistory" resultType="int">
		SELECT COUNT(*) 
		  FROM dut_hst
		 WHERE 1=1
		<if test="searchDate == null or searchDate == ''">
	 		AND DATE_FORMAT(bas_dt, '%Y') = DATE_FORMAT(NOW(), '%Y')
	 	</if>
	 	<!-- <if test="userId != null and userId != ''">
	 		AND user_id = #{userId}
	 	</if>  -->
	</select>

</mapper>